name: AfterlifeOS Builder

on:
  workflow_dispatch:
    inputs:
      DEVICE:
        description: 'Device Codename (e.g., surya, raven)'
        required: true
      BUILD_TYPE:
        description: 'Build Type'
        required: true
        default: 'userdebug'
        type: choice
        options:
          - userdebug
          - user
          - eng
      BUILD_VARIANT:
        description: 'Build Variant'
        required: true
        default: 'Test'
        type: choice
        options:
          - Test
          - Release
      GAPPS_VARIANT:
        description: 'GApps Variant'
        required: true
        default: 'default'
        type: choice
        options:
          - default
          - false
          - core
          - basic
          - true
      LOCAL_MANIFEST_URL:
        description: 'URL to Local Manifest XML'
        required: true
      CLEAN_BUILD:
        description: 'Request Full Clean Build (Admins Only)'
        required: false
        type: boolean
        default: false
      DIRTY_BUILD:
        description: 'Dirty Build (Skip manifest wipe)'
        required: false
        type: boolean
        default: false
      DISABLE_FSGEN:
        description: 'Disable FSGen'
        required: false
        type: boolean
        default: false
  
  repository_dispatch:
    types: [Telegram-Builder]

permissions:
  contents: write
  actions: read

# Global Environment Variables
env:
  DEVICE: ${{ inputs.DEVICE || github.event.client_payload.DEVICE }}
  LOCAL_MANIFEST_URL: ${{ inputs.LOCAL_MANIFEST_URL || github.event.client_payload.LOCAL_MANIFEST_URL }}
  REQUESTER: ${{ github.event.client_payload.REQUESTER }}
  # Grouped Build Config
  BUILD_TYPE: ${{ inputs.BUILD_TYPE || github.event.client_payload.BUILD_CONFIG.BUILD_TYPE }}
  BUILD_VARIANT: ${{ inputs.BUILD_VARIANT || github.event.client_payload.BUILD_CONFIG.BUILD_VARIANT }}
  GAPPS_VARIANT: ${{ inputs.GAPPS_VARIANT || github.event.client_payload.BUILD_CONFIG.GAPPS_VARIANT }}
  CLEAN_BUILD: ${{ inputs.CLEAN_BUILD || github.event.client_payload.BUILD_CONFIG.CLEAN_BUILD }}
  DIRTY_BUILD: ${{ inputs.DIRTY_BUILD || github.event.client_payload.BUILD_CONFIG.DIRTY_BUILD }}
  DISABLE_FSGEN: ${{ inputs.DISABLE_FSGEN || github.event.client_payload.BUILD_CONFIG.DISABLE_FSGEN }}
  # Telegram Meta
  TG_MSG_ID: ${{ github.event.client_payload.TG_META.msg_id }}
  TG_USER_ID: ${{ github.event.client_payload.TG_META.id }}

jobs:
  check-limit:
    name: üõ°Ô∏è Gatekeeper (Check Queue & Quota)
    runs-on: ubuntu-latest
    outputs:
      is_admin: ${{ steps.check_role.outputs.is_admin }}
      msg_id: ${{ env.TG_MSG_ID }}
      fsgen_status: ${{ steps.check_role.outputs.fsgen_status }}
      gapps_display: ${{ steps.check_role.outputs.gapps_display }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Queue Depth
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking global queue depth..."
          COUNT=$(gh run list --workflow afterlife_build.yml --status in_progress --json databaseId --limit 100 | jq length)
          echo "Current active/queued workflows: $COUNT"
          MAX_CONCURRENT=4
          
          if [[ "$COUNT" -gt "$MAX_CONCURRENT" ]]; then
            echo "::error::‚õî QUEUE FULL! There are already 3 builds waiting in line."
            echo "Please try again later when the queue clears."
            exit 1
          fi
          
          echo "‚úÖ Queue check passed. System load is acceptable."

      - name: Check Role & Rate Limit
        id: check_role
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          # Determine FSGen Status String for notifications
          FSGEN_STATUS=""
          if [[ "${{ env.DISABLE_FSGEN }}" == "true" ]]; then
              FSGEN_STATUS="Disabled"
          else
              FSGEN_STATUS="Enabled"
          fi
          echo "FSGEN_STATUS=$FSGEN_STATUS" >> $GITHUB_ENV

          # Determine GApps Display
          case "${{ env.GAPPS_VARIANT }}" in
            "true") GAPPS_DISPLAY="Full" ;;
            "false") GAPPS_DISPLAY="Vanilla" ;;
            "core") GAPPS_DISPLAY="Core" ;;
            "basic") GAPPS_DISPLAY="Basic" ;;
            "default") GAPPS_DISPLAY="Default" ;;
            *) GAPPS_DISPLAY="${{ env.GAPPS_VARIANT }}" ;;
          esac
          echo "GAPPS_DISPLAY=$GAPPS_DISPLAY" >> $GITHUB_ENV

          # --- 1. IDENTIFY USER ROLE ---
          if [[ -n "$REQUESTER" ]]; then
            ACTOR="$REQUESTER"
            echo "ü§ñ Bot Trigger Detected. Acting on behalf of: $ACTOR"
          else
            ACTOR="${{ github.actor }}"
            echo "üë§ Manual Trigger Detected. User: $ACTOR"
          fi
          
          PERM=$(gh api repos/${{ github.repository }}/collaborators/$ACTOR/permission --jq .permission)
          echo "User permission: $PERM"

          if [[ "$PERM" == "admin" ]]; then
            IS_ADMIN="true"
            LIMIT=-1 # Unlimited
            echo "‚úÖ Admin Access Detected. Unlimited Quota."
          else
            IS_ADMIN="false"
            LIMIT=5  # Daily Limit for normal users
            echo "üë§ Standard User Access ($PERM). Quota: $LIMIT/day."
          fi
          
          echo "is_admin=$IS_ADMIN" >> $GITHUB_OUTPUT
          echo "fsgen_status=$FSGEN_STATUS" >> $GITHUB_OUTPUT
          echo "gapps_display=$GAPPS_DISPLAY" >> $GITHUB_OUTPUT

          COUNTER_FILE=".github/workflow_counter.json"
          CURRENT_DATE=$(date +%Y-%m-%d)

          if [[ ! -f "$COUNTER_FILE" ]] || ! jq empty "$COUNTER_FILE" 2>/dev/null; then
            echo "{}" > "$COUNTER_FILE"
          fi

          TODAY_RUNS=$(jq -r --arg user "$ACTOR" --arg date "$CURRENT_DATE" \
            'if .[$user][$date] then .[$user][$date] else 0 end' "$COUNTER_FILE")

          if [[ ! "$TODAY_RUNS" =~ ^[0-9]+$ ]]; then TODAY_RUNS=0; fi

          echo "Usage for $ACTOR on $CURRENT_DATE: $TODAY_RUNS / $LIMIT"

          if [[ $LIMIT -ne -1 && "$TODAY_RUNS" -ge $LIMIT ]]; then
            echo "::error::User $ACTOR has reached the daily limit of $LIMIT builds."

            NEXT_RESET=$(date -d "tomorrow 00:00" +%s)
            NOW=$(date +%s)
            DIFF=$((NEXT_RESET - NOW))
            HOURS_LEFT=$((DIFF / 3600))
            MINS_LEFT=$(( (DIFF % 3600) / 60 ))

            if [[ -n "$TG_USER_ID" ]]; then
                USER_TAG="[$ACTOR](tg://user?id=$TG_USER_ID)"
            else
                USER_TAG="\`$ACTOR\`"
            fi

            # --- REJECT MESSAGE ---
            REJECT_TEXT="üö´ *Build Request Rejected*
            *Device:* \`$DEVICE\`
            *Type:* \`$BUILD_TYPE\`
            *Variant:* \`$BUILD_VARIANT\`
            *FSGen:* \`$FSGEN_STATUS\`
            *Dirty:* \`$DIRTY_BUILD\`
            *Clean:* \`$CLEAN_BUILD\`
            *User:* $USER_TAG
            *Reason:* Daily Limit Reached ($TODAY_RUNS/$LIMIT)
            *Reset In:* ${HOURS_LEFT}h ${MINS_LEFT}m (00:00 UTC)"
            
            if [[ -n "$TG_MSG_ID" ]]; then
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
                -d chat_id="${TELEGRAM_CHAT_ID}" \
                -d message_id="${TG_MSG_ID}" \
                -d parse_mode="Markdown" \
                -d text="$REJECT_TEXT" || true
            else
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                -d chat_id="${TELEGRAM_CHAT_ID}" \
                -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
                -d parse_mode="Markdown" \
                -d text="$REJECT_TEXT" || true
            fi

            exit 1
          fi

          NEW_RUNS=$((TODAY_RUNS + 1))
          jq --arg user "$ACTOR" --arg date "$CURRENT_DATE" --argjson runs "$NEW_RUNS" \
            'if .[$user] then .[$user][$date] = $runs else .[$user] = {($date): $runs} end' "$COUNTER_FILE" > tmp.json && mv tmp.json "$COUNTER_FILE"

          if [[ "$IS_ADMIN" == "true" ]]; then
            QUOTA_INFO="Unlimited ‚ôæÔ∏è"
          else
            REMAINING=$((LIMIT - NEW_RUNS))
            QUOTA_INFO="$NEW_RUNS / $LIMIT (Left: $REMAINING)"
          fi

          if [[ -n "$TG_USER_ID" ]]; then
              USER_TAG="[$ACTOR](tg://user?id=$TG_USER_ID)"
          else
              USER_TAG="\`$ACTOR\`"
          fi

          # --- ACCEPT MESSAGE ---
          ACCEPT_TEXT="‚úÖ *Build Request Accepted*
          *Device:* \`$DEVICE\`
          *Type:* \`$BUILD_TYPE\`
          *Variant:* \`$BUILD_VARIANT\`
          *GApps:* \`$GAPPS_DISPLAY\`
          *FSGen:* \`$FSGEN_STATUS\`
          *Dirty:* \`$DIRTY_BUILD\`
          *Clean:* \`$CLEAN_BUILD\`
          *User:* $USER_TAG
          *Quota Usage:* \`$QUOTA_INFO\`"

          if [[ -n "$TG_MSG_ID" ]]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d message_id="${TG_MSG_ID}" \
              -d parse_mode="Markdown" \
              -d text="$ACCEPT_TEXT"
          else
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
              -d parse_mode="Markdown" \
              -d text="$ACCEPT_TEXT"
          fi

      - name: Commit Counter Update
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git pull --rebase origin main || echo "No changes to pull"
          git add .github/workflow_counter.json
          git commit -m "Update build quota for ${{ env.REQUESTER || github.actor }}" || echo "Nothing to commit"
          git push

  build-on-vps:
    name: üèóÔ∏è Build ROM (${{ inputs.DEVICE || github.event.client_payload.DEVICE }})
    needs: check-limit
    runs-on: self-hosted
    concurrency:
      group: shared-vps-builder
      cancel-in-progress: false
    timeout-minutes: 480
    env:
      TG_MSG_ID: ${{ needs.check-limit.outputs.msg_id }}
      FSGEN_STATUS: ${{ needs.check-limit.outputs.fsgen_status }}
      GAPPS_DISPLAY: ${{ needs.check-limit.outputs.gapps_display }} 
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Save Message ID
        run: |
          echo "$TG_MSG_ID" > .tg_msg_id
          echo "Saved TG_MSG_ID ($TG_MSG_ID) to .tg_msg_id"

      - name: Prepare Scripts
        run: chmod +x builder/*.sh

      - name: Notify Sync Start
        if: env.TG_MSG_ID != ''
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "${{ env.TG_USER_ID }}" ]]; then
             USER_TAG="[${{ env.REQUESTER || github.actor }}](tg://user?id=${{ env.TG_USER_ID }})"
          else
             USER_TAG="\`${{ env.REQUESTER || github.actor }}\`"
          fi

          # --- SYNC MESSAGE ---
          SYNC_TEXT="üîÑ *Syncing Source...*
          *Device:* \`$DEVICE\`
          *Type:* \`$BUILD_TYPE\`
          *Variant:* \`$BUILD_VARIANT\`
          *GApps:* \`${{ env.GAPPS_DISPLAY }}\`
          *FSGen:* \`${{ env.FSGEN_STATUS }}\`
          *Dirty:* \`$DIRTY_BUILD\`
          *Clean:* \`$CLEAN_BUILD\`
          *User:* $USER_TAG
          Please wait...
          *Link:* [View Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d message_id="${TG_MSG_ID}" \
          -d parse_mode="Markdown" \
          -d text="$SYNC_TEXT" > /dev/null || true

      - name: Sync Source
        run: |
          echo "CURRENT_STAGE=Syncing Source" >> $GITHUB_ENV
          echo ">>> Starting Sync on VPS..."
          bash builder/sync.sh

      - name: Disable FSGen (Pre-Build)
        if: env.DISABLE_FSGEN == 'true'
        run: |
          source builder/config.sh
          TARGET_FILE="$ROOTDIR/build/soong/fsgen/Android.bp"
          echo "Targeting: $TARGET_FILE"          
          if [ -f "$TARGET_FILE" ]; then
            echo "‚ö†Ô∏è Backing up and patching FSGen..."
            cp "$TARGET_FILE" "$GITHUB_WORKSPACE/Android.bp.bak"
            sed -i '/name: "soong_filesystem_creator",/a \    enabled: false,' "$TARGET_FILE"
            echo "‚úÖ Patch applied:"
            grep -A 2 "soong_filesystem_creator" "$TARGET_FILE"
          else
            echo "Target file not found. Skipping patch."
          fi

      - name: Build ROM
        env:
          IS_ADMIN: ${{ needs.check-limit.outputs.is_admin }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          echo "CURRENT_STAGE=Building ROM" >> $GITHUB_ENV
          echo ">>> Starting Build for ${{ env.DEVICE }}..."
          echo "Admin Status: $IS_ADMIN"
          bash builder/build.sh

      - name: Restore FSGen (Post-Build)
        if: always() && env.DISABLE_FSGEN == 'true'
        run: |
          source builder/config.sh
          TARGET_FILE="$ROOTDIR/build/soong/fsgen/Android.bp"
          BACKUP_FILE="$GITHUB_WORKSPACE/Android.bp.bak"
          if [ -f "$BACKUP_FILE" ]; then
            echo "‚ôªÔ∏è Restoring original Android.bp..."
            cp -f "$BACKUP_FILE" "$TARGET_FILE"
            rm "$BACKUP_FILE"
            echo "‚úÖ Restoration complete."
          else
            echo "No backup file found to restore."
          fi

      - name: Upload Artifacts
        if: success()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          echo "CURRENT_STAGE=Uploading Artifacts" >> $GITHUB_ENV
          echo ">>> Uploading to external storage..."
          bash builder/smart_upload.sh ${{ env.DEVICE }}

      - name: Notify Workflow Failure
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          # Define path to sync log file (must match what sync.sh creates)
          SYNC_LOG_FILE="${GITHUB_WORKSPACE}/sync_failure.log"

          if [[ "$CURRENT_STAGE" == "Building ROM" ]]; then
            echo "‚ö†Ô∏è Failure occurred in Build ROM stage. Notification handled by build.sh. Skipping global alert."
            exit 0
          elif [[ "$CURRENT_STAGE" == "Syncing Source" ]]; then
            echo "‚ö†Ô∏è Failure occurred in Syncing Source stage. Uploading log..."
            # Check if log file exists and upload it
            if [ -f "$SYNC_LOG_FILE" ]; then
                # Need to use the tg_upload_log function, so source tg_utils.sh
                source builder/tg_utils.sh
                tg_upload_log "$SYNC_LOG_FILE" "Sync Failure Log - ${DEVICE}" "$TELEGRAM_CHAT_ID" || true
                echo "Sync failure log uploaded."
            else
                echo "Sync failure log not found at $SYNC_LOG_FILE."
            fi
          fi

          ACTOR="${{ env.REQUESTER }}"
          if [[ -z "$ACTOR" ]]; then ACTOR="${{ github.actor }}"; fi

          if [[ -n "${{ env.TG_USER_ID }}" ]]; then
             USER_TAG="[${{ env.REQUESTER || github.actor }}](tg://user?id=${{ env.TG_USER_ID }})"
          else
             USER_TAG="\`${{ env.REQUESTER || github.actor }}\`"
          fi

          if [[ -n "$TG_MSG_ID" ]]; then
             METHOD="editMessageText"
             ID_PARAM="-d message_id=$TG_MSG_ID"
          else
             METHOD="sendMessage"
             ID_PARAM=""
          fi
          
          # --- FAILURE MESSAGE ---
          FAIL_TEXT="‚ùå *AfterlifeOS Build FAILED*
          *Device:* \`$DEVICE\`
          *Type:* \`$BUILD_TYPE\`
          *Variant:* \`$BUILD_VARIANT\`
          *GApps:* \`${{ env.GAPPS_DISPLAY }}\`
          *Dirty:* \`$DIRTY_BUILD\`
          *Clean:* \`$CLEAN_BUILD\`
          *FSGen:* \`${{ env.FSGEN_STATUS }}\`
          *User:* $USER_TAG
          *Stage:* \`${CURRENT_STAGE:-Initialization/Setup}\`
          *Link:* [View Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/$METHOD" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            $ID_PARAM \
            -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
            -d parse_mode="Markdown" \
            -d text="$FAIL_TEXT" || true

      - name: Notify Workflow Cancellation
        if: cancelled()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          ACTOR="${{ env.REQUESTER }}"
          if [[ -z "$ACTOR" ]]; then ACTOR="${{ github.actor }}"; fi
          
          if [[ -n "${{ env.TG_USER_ID }}" ]]; then
             USER_TAG="[${{ env.REQUESTER || github.actor }}](tg://user?id=${{ env.TG_USER_ID }})"
          else
             USER_TAG="\`${{ env.REQUESTER || github.actor }}\`"
          fi

          if [[ -n "$TG_MSG_ID" ]]; then
             METHOD="editMessageText"
             ID_PARAM="-d message_id=$TG_MSG_ID"
          else
             METHOD="sendMessage"
             ID_PARAM=""
          fi
          
          # --- CANCEL MESSAGE ---
          CANCEL_TEXT="‚ö†Ô∏è *AfterlifeOS Build Cancelled*
          *Device:* \`$DEVICE\`
          *Type:* \`$BUILD_TYPE\`
          *Variant:* \`$BUILD_VARIANT\`
          *GApps:* \`${{ env.GAPPS_DISPLAY }}\`
          *FSGen:* \`${{ env.FSGEN_STATUS }}\`
          *Dirty:* \`$DIRTY_BUILD\`
          *Clean:* \`$CLEAN_BUILD\`
          *User:* $USER_TAG
          *Stage:* \`${CURRENT_STAGE:-Initialization}\`
          *Link:* [View Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/$METHOD" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            $ID_PARAM \
            -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
            -d parse_mode="Markdown" \
            -d text="$CANCEL_TEXT" || true
