name: Build on VPS (Self-Hosted)

on:
  workflow_dispatch:
    inputs:
      DEVICE:
        description: 'Device Codename (e.g., raven)'
        required: true
        default: 'bacon'
      BUILD_TYPE:
        description: 'Build Type'
        required: true
        default: 'userdebug'
        type: choice
        options:
        - userdebug
        - user
        - eng
      LOCAL_MANIFEST_URL:
        description: 'URL to Local Manifest XML'
        required: true
      CLEAN_BUILD:
        description: 'Clean Build? (true/false)'
        required: false
        type: boolean
        default: false

jobs:
  build-on-vps:
    # Gunakan label paling umum untuk menangkap runner organisasi
    runs-on: self-hosted
    
    # Set timeout agar job tidak menggantung selamanya jika error
    timeout-minutes: 480 

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Prepare Scripts
      run: chmod +x builder/*.sh

    - name: Sync Source
      env:
        LOCAL_MANIFEST_URL: ${{ inputs.LOCAL_MANIFEST_URL }}
      run: |
        echo "Starting Sync on VPS..."
        bash builder/sync.sh

    - name: Build ROM
      env:
        DEVICE: ${{ inputs.DEVICE }}
        BUILD_TYPE: ${{ inputs.BUILD_TYPE }}
        CLEAN_BUILD: ${{ inputs.CLEAN_BUILD }}
      run: |
        echo "Starting Build for ${{ inputs.DEVICE }} on VPS..."
        bash builder/build.sh

    - name: Upload Artifact (Optional)
      # Upload zip ke halaman GitHub Actions agar mudah didownload
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: AfterlifeOS-${{ inputs.DEVICE }}
        path: source/out/target/product/${{ inputs.DEVICE }}/*.zip
